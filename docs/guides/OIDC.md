# OpenID Connect (OIDC) Setup Guide

This guide will walk you through setting up OpenID Connect (OIDC) authentication for your application. OIDC allows you to use external identity providers (IdPs) like Keycloak, Dex, Google, or GitHub for user authentication.

## Prerequisites

Before starting, ensure you have:
- A running instance of the application.
- A public URL for your instance (e.g., `https://app.example.com`).
- An OIDC Identity Provider (e.g., Keycloak, Authentik, Google Cloud Console).
- Admin access to your OIDC Provider to create a client.

## Configuration

The application uses environment variables to configure OIDC. These should be set in your `.env` file or your deployment environment.

| Variable | Description | Example |
| :--- | :--- | :--- |
| `OIDC_ISSUER` | The base URL of your OIDC provider. | `https://keycloak.example.com/realms/myrealm` |
| `OIDC_CLIENT_ID` | The Client ID generated by your IdP. | `my-app` |
| `OIDC_CLIENT_SECRET` | The Client Secret generated by your IdP. | `your-very-secret-key` |
| `OIDC_REDIRECT_URL` | The callback URL the application should listen on. | `https://app.example.com/auth/callback` |

> [!IMPORTANT]
> The `OIDC_REDIRECT_URL` must exactly match the redirect/callback URI configured in your OIDC provider's settings.

---

## Provider Setup Examples

### 1. Keycloak

1. Log in to your Keycloak Admin Console.
2. Select your **Realm** (or create a new one).
3. Go to **Clients** -> **Create client**.
4. Set **Client type** to `OpenID Connect` and **Client ID** to `my-app`.
5. In **Capability config**, ensure **Standard flow** is enabled.
6. In **Login settings**:
   - **Valid redirect URIs**: `https://app.example.com/auth/callback`
   - **Web origins**: `https://app.example.com`
7. Go to the **Credentials** tab and copy the **Client secret**.

**Environment Variables for Keycloak:**
```bash
OIDC_ISSUER=https://keycloak.example.com/realms/myrealm
OIDC_CLIENT_ID=my-app
OIDC_CLIENT_SECRET=YOUR_KEYCLOAK_SECRET
OIDC_REDIRECT_URL=https://app.example.com/auth/callback
```

### 2. Google Cloud Console

1. Go to the [Google Cloud Console](https://console.cloud.google.com/).
2. Create a new project or select an existing one.
3. Go to **APIs & Services** -> **OAuth consent screen**. Configure it for "External" or "Internal" users.
4. Go to **APIs & Services** -> **Credentials**.
5. Click **Create Credentials** -> **OAuth client ID**.
6. Select **Application type**: `Web application`.
7. Add **Authorized redirect URIs**: `https://app.example.com/auth/callback`.
8. Copy the **Client ID** and **Client Secret**.

**Environment Variables for Google:**
```bash
OIDC_ISSUER=https://accounts.google.com
OIDC_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
OIDC_CLIENT_SECRET=your-google-client-secret
OIDC_REDIRECT_URL=https://app.example.com/auth/callback
```

---

## Troubleshooting

### Redirect URI Mismatch
This is the most common error. Ensure that `OIDC_REDIRECT_URL` in your environment variables matches the "Authorized Redirect URI" in your IdP exactly, including the protocol (`https://`) and any trailing slashes.

### SSL/TLS Issues
Most OIDC providers require `https`. If you are running the application on `http` (e.g., during local development), ensure your IdP allows non-secure redirects or use a tool like `ngrok` to expose your local instance over `https`.

### Scope Issues
The application requests the following scopes: `openid`, `profile`, and `email`. Ensure your OIDC client is allowed to request these scopes. In Keycloak, these are usually default "Client Scopes".
