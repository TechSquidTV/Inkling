# Backend Architecture

The backend is built with **Go** and follows a modular structure designed for scalability, type-safety, and automatic documentation.

## Frameworks & Libraries

### [Huma (v2)](https://huma.rocks/)
Huma is the primary web framework used for building the REST API. It is built on top of standard Go libraries and provides:
- **Automatic OpenAPI 3.1 & JSON Schema Generation**: The API documentation is always in sync with the code.
- **Type-Safe Request/Response**: Uses Go structs with tags to define inputs (path, query, body) and outputs.
- **CLI Integration**: Built-in CLI support via `humacli` for configuration and utilities.
- **Interactive Docs**: Available at `/docs` out of the box.

### [Chi (v5)](https://github.com/go-chi/chi)
Chi is used as the underlying HTTP router. It is lightweight, idiomatic, and high-performance.
- **Middleware Support**: Uses standard Chi/Go HTTP middleware for logging, recovery, and CORS.
- **Adapter for Huma**: Huma integrates seamlessly with Chi via the `humachi` adapter.

### [GORM](https://gorm.io/)
GORM is the developer-friendly ORM for Golang.
- **SQLite Support**: The project uses SQLite as the default database.
- **Auto Migrations**: Models defined in `internal/database/models.go` are automatically migrated on startup.
- **Type-Safe Helpers**: Uses GORM CLI/Gen for type-safe code generation.

### [Charm Log](https://github.com/charmbracelet/log)
A minimal and colorful Go logging library used for structured logging.
- **Colorful Output**: Human-readable, styled logs using Lip Gloss.
- **Structured Logging**: Supports key-value pairs for better context.
- **Leveled Logging**: Includes Debug, Info, Warn, Error, and Fatal levels.

## Project Structure

```text
cmd/server/
  └── main.go           # Entry point, CLI configuration, and server startup.
cmd/gen/
  └── main.go           # GORM CLI generation script.
internal/api/
  ├── api.go            # Central route registration and DB dependency injection.
  └── handlers/         # API endpoint handlers and models.
internal/database/
  ├── database.go       # DB initialization and migration logic.
  ├── models.go         # GORM model definitions.
  └── generated/        # Type-safe query helpers generated by GORM CLI.
```

## CLI Usage

The server uses `humacli` based on `cobra`.

- **Start Server**: `go run cmd/server/main.go`
- **Set Port**: `go run cmd/server/main.go --port 8888`
- **Set DB Path**: `go run cmd/server/main.go --dbpath data.db`
- **Generate OpenAPI**: `go run cmd/server/main.go openapi > openapi.json`
- **Generate GORM Helpers**: `go run cmd/gen/main.go`

## Generating API Documentation

The project supports automatic OpenAPI 3.1 specification generation. This is useful for:
- Generating client SDKs (TypeScript, Python, etc.)
- Integrating with API gateways
- Hosting static API documentation

### Reference the OpenAPI Spec
You can generate the spec by running the `openapi` command:

```bash
go run cmd/server/main.go openapi > openapi.json
```

The output is a standard OpenAPI 3.1 JSON file.

### Interactive Documentation
When the server is running, you can access the interactive ReDoc capability at:
- `http://localhost:8080/docs`

## API Design Patterns

### Models
Expects requests and responses to be defined as structs. Body parameters are encapsulated within a `Body` field.

```go
type MyOutput struct {
    Body struct {
        Message string `json:"message" example:"Hello" doc:"A message"`
    }
}
```

### Registration
func huma.Get(api huma.API, path string, handler interface{}) {
    // Logic here
}
```

## Database & ORM

### Initializing the Database
The database is initialized in `cmd/server/main.go` and passed to `api.RegisterHandlers`.

```go
db, err := database.InitDB(options.DBPath)
if err != nil {
    log.Fatalf("failed to connect database: %v", err)
}
api.RegisterHandlers(humaAPI, db)
```

### Models & Migrations
Define your models in `internal/database/models.go`. They are automatically migrated in `database.InitDB`.

```go
type User struct {
    gorm.Model
    Name string
}
```

### Type-Safe Queries
We use `gorm.io/gen` to generate type-safe helpers. Run `go run cmd/gen/main.go` after adding or modifying models.

```go
q := generated.Use(db)
user, err := q.User.ExampleHandler() // etc
```

## Tutorial: Adding a New Route

See [Creating New Endpoints](../guides/creating-new-endpoints.md) for a step-by-step guide on adding new API endpoints.

